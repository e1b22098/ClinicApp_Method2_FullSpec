<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.unknownclinic.appointment.repository.BookingMapper">

    <resultMap id="BookingResultMap" type="com.unknownclinic.appointment.domain.Booking">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="businessDate" column="business_date"/>
        <result property="timeSlotId" column="time_slot_id"/>
        <result property="status" column="status" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="userName" column="user_name"/>
        <result property="userPhoneNumber" column="user_phone_number"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
    </resultMap>

    <select id="findById" resultMap="BookingResultMap">
        SELECT b.id, b.user_id, b.business_date, b.time_slot_id, b.status,
               b.created_at, b.updated_at,
               u.name AS user_name, u.phone_number AS user_phone_number,
               ts.start_time, ts.end_time
        FROM bookings b
        LEFT JOIN users u ON b.user_id = u.id
        LEFT JOIN time_slots ts ON b.time_slot_id = ts.id
        WHERE b.id = #{id}
    </select>

    <select id="findByUserId" resultMap="BookingResultMap">
        SELECT b.id, b.user_id, b.business_date, b.time_slot_id, b.status,
               b.created_at, b.updated_at,
               u.name AS user_name, u.phone_number AS user_phone_number,
               ts.start_time, ts.end_time
        FROM bookings b
        LEFT JOIN users u ON b.user_id = u.id
        LEFT JOIN time_slots ts ON b.time_slot_id = ts.id
        WHERE b.user_id = #{userId}
          AND b.status != 'CANCELLED'
        ORDER BY b.business_date DESC, ts.start_time ASC
    </select>

    <select id="findByBusinessDate" resultMap="BookingResultMap">
        SELECT b.id, b.user_id, b.business_date, b.time_slot_id, b.status,
               b.created_at, b.updated_at,
               u.name AS user_name, u.phone_number AS user_phone_number,
               ts.start_time, ts.end_time
        FROM bookings b
        LEFT JOIN users u ON b.user_id = u.id
        LEFT JOIN time_slots ts ON b.time_slot_id = ts.id
        WHERE b.business_date = #{businessDate}
          AND b.status != 'CANCELLED'
        ORDER BY ts.start_time ASC
    </select>

    <select id="findByBusinessDateAndTimeSlot" resultMap="BookingResultMap">
        SELECT b.id, b.user_id, b.business_date, b.time_slot_id, b.status,
               b.created_at, b.updated_at,
               u.name AS user_name, u.phone_number AS user_phone_number,
               ts.start_time, ts.end_time
        FROM bookings b
        LEFT JOIN users u ON b.user_id = u.id
        LEFT JOIN time_slots ts ON b.time_slot_id = ts.id
        WHERE b.business_date = #{businessDate}
          AND b.time_slot_id = #{timeSlotId}
          AND b.status != 'CANCELLED'
    </select>

    <select id="findByUserAndDateAndTimeSlot" resultMap="BookingResultMap">
        SELECT b.id, b.user_id, b.business_date, b.time_slot_id, b.status,
               b.created_at, b.updated_at,
               u.name AS user_name, u.phone_number AS user_phone_number,
               ts.start_time, ts.end_time
        FROM bookings b
        LEFT JOIN users u ON b.user_id = u.id
        LEFT JOIN time_slots ts ON b.time_slot_id = ts.id
        WHERE b.user_id = #{userId}
          AND b.business_date = #{businessDate}
          AND b.time_slot_id = #{timeSlotId}
          AND b.status != 'CANCELLED'
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO bookings (user_id, business_date, time_slot_id, status, created_at, updated_at)
        VALUES (#{userId}, #{businessDate}, #{timeSlotId}, #{status, typeHandler=org.apache.ibatis.type.EnumTypeHandler}, NOW(), NOW())
    </insert>

    <update id="update">
        UPDATE bookings
        SET status = #{status},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <update id="cancel">
        UPDATE bookings
        SET status = 'CANCELLED',
            updated_at = NOW()
        WHERE id = #{id}
    </update>

</mapper>

